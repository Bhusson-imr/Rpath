---
title: "R Ecosystem"
author: "Sean M. Lucey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R Ecosystem}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Rpath is an implementation of the ecosystem model Ecopath with Ecosim (EwE; 
Christensen and Walters 2001).  This vignette describes some of the basic 
functionality of the package using a fictional ecosystem, R Ecosystem.  Any 
resemblance to an actual ecosystem is purely coincidental.  To see the underlying mathematics please refer to Lucey et al. (in prep).
```{r echo = F}
library(Rpath)
````

## Ecopath

### Parameter file generation
Unlike the GUI based EwE software package, Rpath relies on a series of parameter
files.  A skeleton for a parameter file can be created using the function 
`create.rpath.param`.  Once created, it can be populated either within R or an 
external spreadsheet software such as Excel.  There are four different parameter
files: model, diet, juvenile, and pedigree.  The function `create.rpath.param`
can generate any of the four by setting the argument "parameter" to the desired 
type.  The parameter files do not need to be generated by `create.rpath.param` in
order to work with the model but this function can be helpful to ensure that all 
of the correct columns are in the appropriate parameter files.

#### Model parameter file
The data entered in the model parameter file are similar to the data entered in the 
input data tabs in EwE.  The model parameter file contains all of the biomass, 
production to biomass, consumption to biomass, etc. parameters as well as the detrital 
fate parameters and fleet landings and discards. The `create.rpath.param` function 
requires a vector of group names and a vector of their corresponding type (Living = 0, 
Primary Producer = 1, Detritus = 2, Fleet = 3).

```{r}
#Groups and types for the R Ecosystem

groups <- c('Seabirds', 'Whales', 'Seals', 'JuvRoundfish1', 'AduRoundfish1', 
            'JuvRoundfish2', 'AduRoundfish2', 'JuvFlatfish1', 'AduFlatfish1',
            'JuvFlatfish2', 'AduFlatfish2', 'OtherGroundfish', 'Foragefish1',
            'Foragefish2', 'OtherForagefish', 'Megabenthos', 'Shellfish',
            'Macrobenthos', 'Zooplankton', 'Phytoplankton', 'Detritus', 
            'Discards', 'Trawlers', 'Midwater', 'Dredgers')

types  <- c(rep(0, 19), 1, rep(2, 2), rep(3, 3))

modfile <- create.rpath.param(parameter = 'model', group = groups, type = types)
```

```{r, echo=FALSE, results='asis'}
knitr::kable(modfile, caption = 'Example table created using the 
             `create.rpath.param` function')
```

Note there is the option to save the parameter file by passing a name to the 
"filename" argument.  Each of the parameter files are created as data tables.
Data tables are an extention of the classic data frame class.  They allow for 
simplified indexing which can help populate the files in R.  For example you can
add data to a specific slot or fill an entire column.

```{r}
#Example of filling specific slots
modfile <- modfile[Group %in% c('Seals', 'Megabenthos'), EE := 0.8]

#Example of filling an entire column
biomass <- c(0.0149, 0.454, NA, 0.130, 1.39, 1.233, 5.553, 0.070, 5.766, 0.096,
             0.739, 7.4, 5.1, 4.7, 5.1, NA, 7, 17.4, 23, 10, rep(NA, 5))
modfile <- modfile[, Biomass := biomass]

```
Note the use of the operator ':=' to assign values.  This is unique to data tables.
```{r, echo = F}
knitr::kable(modfile[, list(Group, Type, Biomass, EE)], 
             caption = 'Example of assigning a specific slot or a whole column')

```

Here is the completed model parameter file for R Ecosystem:
```{r}
#PB and QB
pb <- c(0.098, 0.031, 0.100, 2.026, 0.42, 2.1, 0.425, 1.5, 0.26, 1.1, 0.18, 0.6,
        0.61, 0.65, 1.5, 0.9, 1.3, 7, 39, 240, rep(NA, 5))
qb <- c(76.750, 6.976, 34.455, 8.414, 2.19, 10.94, 3.78, 8.008, 1.44, 5.839, 1.69,
        1.764, 3.52, 5.65, 3.6, 2.984, rep (NA, 9))
modfile <- modfile[, PB := pb]
modfile <- modfile[, QB := qb]

#Production to Consumption for those groups without a QB
modfile <- modfile[Group %in% c('Shellfish', 'Zooplankton'), ProdCons:= 0.25]
modfile <- modfile[Group == 'Macrobenthos', ProdCons := 0.35]

#Biomass accumulation and unassimilated production
modfile <- modfile[, BioAcc  := c(rep(0, 22), rep(NA, 3))]
modfile <- modfile[, Unassim := c(rep(0.2, 18), 0.4, rep(0, 3), rep(NA, 3))]

#Detrital Fate
modfile <- modfile[, Detritus := c(rep(1, 20), rep(0, 5))]
modfile <- modfile[, Discards := c(rep(0, 22), rep(1, 3))]

#Fisheries
#Landings
trawl  <- c(rep(0, 4), 0.08, 0, 0.32, 0, 0.09, 0, 0.05, 0.2, rep(0, 10), rep(NA, 3))
mid    <- c(rep(0, 12), 0.3, 0.08, 0.02, rep(0, 7), rep(NA, 3))
dredge <- c(rep(0, 15), 0.1, 0.5, rep(0, 5), rep(NA, 3))
modfile <- modfile[, Trawlers := trawl]
modfile <- modfile[, Midwater := mid]
modfile <- modfile[, Dredgers := dredge]

#Discards
trawl.d  <- c(1e-5, 1e-7, 0.001, 0.001, 0.005, 0.001, 0.009, 0.001, 0.04, 0.001,
              0.01, 0.08, 0.001, 0.001, 0.001, rep(0, 7), rep(NA, 3))
mid.d    <- c(rep(0, 2), 0.001, 0.001, 0.01, 0.001, 0.01, rep(0, 4), 0.05, 0.05,
              0.01, 0.01, rep(0, 7), rep(NA, 3))
dredge.d <- c(rep(0, 3), 0.001, 0.05, 0.001, 0.05, 0.001, 0.05, 0.001, 0.01, 0.05,
              rep(0, 3), 0.09, 0.01, 1e-4, rep(0, 4), rep(NA, 3))
modfile <- modfile[, Trawlers.disc := trawl.d]
modfile <- modfile[, Midwater.disc := mid.d]
modfile <- modfile[, Dredgers.disc := dredge.d]
```
```{r, echo = F}
knitr::kable(modfile, caption = 'Model Parameter file for R Ecosystem')
```


#### Diet parameter file

The data entered in the diet parameter file is the same as the data entered in the 
diet composition tab in EwE. Once again, `create.rpath.param` will generate a 
skeleton of the diet parameter file using a vector of group names and types as 
well as setting the argument 'parameter' to 'diet'.  Just as within EwE, the columns 
represent the predators while the rows represent the prey.

```{r}
dietfile <- create.rpath.param(parameter = 'diet', group = groups, type = types)
```
```{r echo = F}
knitr::kable(dietfile, caption = 'Skeleton of the diet parameter file generated 
             by `create.rpath.param` function')
```

Individual diet components can be adjusted by specifying the prey in the 'Group'
variable and assigning the value to the predator.  For example, if you wanted to
assign 10% of the seabird diet as 'Other Groundfish' you could do it like this:
```{r}
dietfile <- dietfile[Group == 'OtherGroundfish', Seabirds := 0.1]
```
You can also assign the entire diet composition for a predator:
```{r}
whale.diet <- c(rep(NA, 3), 0.01, NA, 0.01, NA, 0.01, NA, 0.01, rep(NA, 4), 0.1,
                rep(NA, 3), 0.86, rep(NA, 3))
dietfile <- dietfile[, Whales := whale.diet]
```
```{r echo = F}
knitr::kable(dietfile[, list(Group, Seabirds, Whales)])
```

Here is the completed model parameter file for R Ecosystem:
```{r}
seabird.diet <- c(rep(NA, 11), 0.1, 0.25, 0.2, 0.15, rep(NA, 6), 0.3)
seal.diet    <- c(rep(NA, 3), 0.05, 0.1, 0.05, 0.2, 0.005, 0.05, 0.005, 0.01, 0.24, 
                  rep(0.05, 4), 0.09, rep(NA, 5))
juvrf.diet   <- c(rep(NA, 3), rep(c(1e-4, NA), 4), 1e-3, rep(NA, 2), 0.05, 1e-4,
                  NA, .02, .7785, .1, .05, NA)
rf1.diet     <- c(rep(NA, 5), 1e-3, 0.01, 1e-3, 0.05, 1e-3, 0.01, 0.29, 0.1, 0.1,
                  0.347, 0.03, NA, 0.05, 0.01, rep(NA, 3))
rf2.diet     <- c(rep(NA, 3), 1e-4, NA, 1e-4, NA, rep(1e-4, 4), 0.1, rep(0.05, 3),
                  0.2684, 0.01, 0.37, 0.001, NA, 0.1, NA)
juvff.diet   <- c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 3), rep(1e-4, 2), NA,
                  0.416, 0.4334, 0.1, 0.05, NA)
ff1.diet     <- c(rep(NA, 7), rep(1e-4, 5), rep(NA, 2), 0.001, 0.05, 0.001, 0.6, 
                  0.2475, NA, 0.1, NA)
ff2.diet     <- c(rep(NA, 7), 1e-4, NA, 1e-4, rep(NA, 4), rep(1e-4, 3), 0.44, 0.3895,
                  NA, 0.17, NA)
ogf.diet     <- c(rep(NA, 3), rep(1e-4, 8), 0.05, 0.08, 0.0992, 0.3, 0.15, 0.01,
                  0.3, 0.01, rep(NA, 3))
forage.diet  <- c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 7), 0.8196, 0.06, 0.12, NA)
megaben.diet <- c(rep(NA, 15), 0.1, 0.03, 0.55, rep(NA, 2), 0.32, NA)
shell.diet   <- c(rep(NA, 18), 0.3, 0.5, 0.2, NA)
macro.diet   <- c(rep(NA, 16), 0.01, rep(0.2, 2), NA, 0.59, NA)
zoo.diet     <- c(rep(NA, 18), 0.2, 0.6, 0.2, NA)

dietfile <- dietfile[, Seabird         := seabird.diet]
dietfile <- dietfile[, Seals           := seal.diet]
dietfile <- dietfile[, JuvRoundfish1   := juvrf.diet]
dietfile <- dietfile[, AduRoundfish1   := rf1.diet]
dietfile <- dietfile[, JuvRoundfish2   := juvrf.diet]
dietfile <- dietfile[, AduRoundfish2   := rf2.diet]
dietfile <- dietfile[, JuvFlatfish1    := juvff.diet]
dietfile <- dietfile[, AduFlatfish1    := ff1.diet]
dietfile <- dietfile[, JuvFlatfish2    := juvff.diet]
dietfile <- dietfile[, AduFlatfish2    := ff2.diet]
dietfile <- dietfile[, OtherGroundfish := ogf.diet]
dietfile <- dietfile[, Foragefish1     := forage.diet]
dietfile <- dietfile[, Foragefish2     := forage.diet]
dietfile <- dietfile[, OtherForagefish := forage.diet]
dietfile <- dietfile[, Megabenthos     := megaben.diet]
dietfile <- dietfile[, Shellfish       := shell.diet]
dietfile <- dietfile[, Macrobenthos    := macro.diet]
dietfile <- dietfile[, Zooplankton     := zoo.diet]

```
```{r, echo = F}
knitr::kable(dietfile, caption = 'Diet parameter file for R Ecosystem')
```

Just like the model parameter file, there is the option to save the parameter 
file by passing a name to the "filename" argument.

#### Juvenile parameter file

Rpath is currently set up to only handle adult and juvenile stanzas.  We expect 
to expand this capability to multi-stanzas in the near future.  If your model
does not have any groups with stanzas, you still need to generate a juvenile
parameter file.  The easiest way to do this is to call the `create.rpath.param`
function without any groups.
```{r}
juvfile <- create.rpath.param(parameter = 'juvenile')
```
```{r, echo = F}
knitr::kable(juvfile, caption = 'Juvenile parameter file created without any
             multi-stanza groups')
```

If you are generating a juvenile parameter file for groups with stanzas, the
'group' argument should be a vector of the stanza group names (i.e. adults and
juveniles named the same).
```{r}
juvfile <- create.rpath.param(parameter = 'juvenile', 
                              group = c('Roundfish1', 'Roundfish2', 'Flatfish1', 
                                        'Flatfish2'))
```
```{r, echo = F}
knitr::kable(juvfile, caption = 'Juvenile parameter file created with stanza groups')
```

The JuvNum and AduNum variables refer to the group number of the juveniles and 
adults respectively.  This refers to there position in the model and diet parameter
files.
```{r, comment = '>', results = 'hold'}
#Roundfish1
cat('JuvRoundfish1:')
which(groups == 'JuvRoundfish1')
cat('AduRoundfish1:')
which(groups == 'AduRoundfish1')
```
RecAge and RecMonth are the variables that tell Rpath when to advance the biomass
from the juvenile stanza to the adult month.  The RecAge variable is in years while
the RecMonth is the numeric representation of the month when spawning occurs.  If
set to zero the spawning is assumed to happen throughout the year.

VonBK is the the specialized von Bertalanffy growth coefficient (Essington et al. 
2001).  Rpath actually calculates growth using the "generalized" von Bertalanffy 
growth equation so this k is multiplied by 3 when used.  The "specialized" equation
is simplified from the "generalized" equation by assuming that consumption rates
scale with body size to the 2/3 power.  This can be changed in Rpath by specifying
a value other than 0.6667 for the VonBD variable.  By default, `create.rpath.param`
populates the VonBD variable with 0.6667.

Other variables in the juvenile parameter file include AduZ_BAB and JuvZ_BAB 
variables.  These are the total mortality terms for the adult and juvenile stanzas 
respectively.  Total mortality can be estimated using the PB ratio.  Note that if
the PB value and Z_BAB value are different, Rpath will use the difference as a biomass
accumulation term.  This can lead to strange behavior in the model.


The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
