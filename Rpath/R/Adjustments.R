#'Fishing Mortality Table
#'
#'Creates a table of fishing mortalities by species group and gear for an Rpath.sim object.
#'
#'@family Rpath functions
#'
#'@param Rsim.scenario Object generated by rsim.scenario.
#'
#'@return Returns a data table of F values for each species/gear combination.
#'@export 
frate.table <- function(Rsim.scenario){
  fish <- data.table(Group = Rsim.scenario$params$FishFrom,
                     Gear  = Rsim.scenario$params$FishThrough,
                     Q     = Rsim.scenario$params$FishQ)
  group <- unique(fish[Group > 0, Group])
  gear  <- unique(fish[Gear  > 0, Gear])
  
  group.name <- Rsim.scenario$params$spname[unique(fish[Group > 0, Group]) + 1]
  gear.name  <- Rsim.scenario$params$spname[unique(fish[Gear  > 0, Gear ]) + 1]
  
  fish.out <- c()
  for(i in 1:length(group)){
    fish.group <- fish[Group == group[i], ]
    fish.all.gear <- data.table(Group = group.name[i])
    for(j in 1:length(gear)){
      f.gear <- data.table(Group = group.name[i], V1 = fish.group[Gear == gear[j], sum(Q)])
      setnames(f.gear, 'V1', gear.name[j])
      fish.all.gear <- merge(fish.all.gear, f.gear, by = 'Group')
    }
    fish.out <- rbindlist(list(fish.out, fish.all.gear))
  }
  Total <- fish.out[, rowSums(.SD), .SDcols = gear.name]
  fish.out <- cbind(fish.out, Total)
  return(fish.out)
}

#'Adjust Fishing Mortality
#'
#'Modifies the fishing mortality value for a species by a particular gear.
#'
#'@family Rpath functions
#'
#'@param Rsim.scenario Object generated by ecosim.scenario.
#'@param parameter One of three parameters to be modified: EFFORT, FRATE, or CATCH
#'@param group Name or number of the species group whose fishing parameter is being changed.
#'@param gear Name or number of the gear to which the change applies.
#'@param year Year of the simulation that should be modified.  Can be a range of years.
#'@param value New value for the parameter.
#'
#'@return Returns an Rpath.sim object with the new fishing parameter.
#'@export 
adjust.fishing <- function(Rsim.scenario, parameter, group = NA, gear = NA, 
                           year, value){
  #Lookup gear/group numbers
  if(!is.na(group)){
    groupnum <- Rsim.scenario$params$spnum[which(Rsim.scenario$params$spname 
                                                 == group)]
  }
  if(!is.na(gear)){
    gearnum <- Rsim.scenario$params$spnum[which(Rsim.scenario$params$spname
                                                == gear)]
    gearnum <- gearnum - (Rsim.scenario$params$NUM_LIVING + 
                            Rsim.scenario$params$NUM_DEAD)
  }
  
  #Lookup parameter number
  param.num <- which(names(Rsim.scenario$fishing) == parameter)
  
  #Modify parameter
  if(parameter == 'EFFORT'){
    Rsim.scenario$fishing$EFFORT[year, gearnum + 1] <- value
  }
  if(parameter %in% c('FRATE', 'CATCH')){
    Rsim.scenario$fishing[[param.num]][year, groupnum + 1] <- value
  }
  return(Rsim.scenario)
}



#'Adjust Rsim.scenario parameters
#'
#'Modifies the various parameters of the rsim scenario object.
#'
#'@family Rpath functions
#'
#'@param Rsim.scenario Object generated by rsim.scenario.
#'@param parameter The Rsim.scenario parameter to be modified. (Create a table)
#'@param group The model group that the parameter change will affect.  Note that 
#'       a value of 'all' will affect all groups associate with the groupto
#'       variable.
#'@param groupto The coresponding group who's parameter is affecting the group
#'       variable.
#'@param value The new value for the parameter.
#'@return Returns an Rsim.scenario object with the new parameter.
#'@export 
adjust.scenario <- function(Rsim.scenario, parameter, group, groupto = NA, value){
  #Lookup group numbers
  if(group == 'all'){
    groupnum <- 0:Rsim.scenario$params$NUM_GROUPS
  } else {
    groupnum <- Rsim.scenario$params$spnum[which(Rsim.scenario$params$spname 
                                                 == group)]
  }
  if(!is.na(groupto)){
    groupnumto <- Rsim.scenario$params$spnum[which(Rsim.scenario$params$spname 
                                                 == groupto)]
  }
  
  #Lookup parameter number
  param.num <- which(names(Rsim.scenario$params) == parameter)
  
  #Modify parameter
  if(parameter %in% c('B_BaseRef', 'MzeroMort', 'UnassimRespFrac', 'ActiveRespFrac',
                      'FtimeAdj', 'FtimeQBOpt', 'PBopt', 'fish_Effort', 
                      'NoIntegrate', 'HandleSelf', 'ScrambleSelf')){
    Rsim.scenario$params[[param.num]][groupnum + 1] <- value
  }
  
  if(parameter %in% c('QQ', 'DD', 'VV', 'HandleSwitch', 'PredPredWeight', 
                      'PreyPreyWeight', 'PredTotWeight', 'PreyTotWeight')){
      linknum <- which(Rsim.scenario$params$PreyFrom %in% groupnum &
                         Rsim.scenario$params$PreyTo == groupnumto)  
    Rsim.scenario$params[[param.num]][linknum] <- value
  }
  return(Rsim.scenario)
}

# KYA - Some "adjustment" functions for Rsim.  Used "set" instead of "adjust" as
# that's more of a standard naming convention.  (In future make this a method
# of objects?)
###############################################################################
#'@export  
set.rsim.scene<-function(Rsim.scenario,params=NULL,start_state=NULL,forcing=NULL,fishing=NULL,stanzas=NULL){
  rsim <- list()
  class(rsim) <- 'Rsim.scenario'
  attr(rsim, 'eco.name') <- attr(Rsim.scenario, 'eco.name')
  # can add type checks later
    if (!is.null(params))     {rsim$params      <- params      } else {rsim$params      <- Rsim.scenario$params      }
    if (!is.null(start_state)){rsim$start_state <- start_state } else {rsim$start_state <- Rsim.scenario$start_state }
    if (!is.null(forcing))    {rsim$forcing     <- forcing     } else {rsim$forcing     <- Rsim.scenario$forcing     }
    if (!is.null(fishing))    {rsim$fishing     <- fishing     } else {rsim$fishing     <- Rsim.scenario$fishing     }
    if (!is.null(stanzas))    {rsim$stanzas     <- stanzas     } else {rsim$stanzas     <- Rsim.scenario$stanzas     }
  return(rsim)
}

#'@export  
get.rsim.params<-function(Rsim.scenario){
  return(Rsim.scenario$params)
}

#'@export  
get.rsim.start_state<-function(Rsim.scenario){
  return(Rsim.scenario$start_state)
}

#'@export  
get.rsim.forcing<-function(Rsim.scenario){
  return(Rsim.scenario$forcing)
}

#'@export  
get.rsim.fishing<-function(Rsim.scenario){
  return(Rsim.scenario$fishing)
}

#'@export  
get.rsim.stanzas<-function(Rsim.scenario){
  return(Rsim.scenario$stanzas)
}


#'Adjust Forcing Parameters
#'
#'Modifies the various forcing parameters of the rsim scenario object.
#'
#'@family Rpath functions
#'
#'@param Rsim.scenario Object generated by rsim.scenario.
#'@param parameter The Rsim.scenario parameter to be modified. 
#'@param group The model group that the parameter change will affect.
#'@param year Year of the simulation that should be modified.  Can be a range of years.  
#'@param value The new value for the parameter.
#'@return Returns an Rsim.scenario object with the new parameter.
#'@export 
adjust.forcing <- function(Rsim.scenario, parameter, group, time, value){
  #Lookup group number
  groupnum <- Rsim.scenario$params$spnum[which(Rsim.scenario$params$spname == group)]
  
  #Lookup parameter number
  if(parameter == 'byprey')    param.num <- 1
  if(parameter == 'bymort')    param.num <- 2
  if(parameter == 'byrecs')    param.num <- 3
  if(parameter == 'bysearch')  param.num <- 4
  if(parameter == 'bymigrate') param.num <- 5
  
  #Modify parameter
  Rsim.scenario$forcing[[param.num]][time, groupnum + 1] <- value

  return(Rsim.scenario)
}




